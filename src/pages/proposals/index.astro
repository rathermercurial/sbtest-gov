---
import { getCollection } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { readFile } from 'node:fs/promises';
import { Marked } from 'marked';

// Read and parse the index.md file from the governance submodule
const indexPath = './src/content/governance/proposals/index.md';
const indexContent = await readFile(indexPath, 'utf-8');

// Extract frontmatter
const frontmatterMatch = indexContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
let description = 'Institutional memory archive preserving decision-making processes and deliberative context';
let markdownContent = indexContent;

if (frontmatterMatch) {
	const frontmatter = frontmatterMatch[1];
	markdownContent = frontmatterMatch[2];
	const descMatch = frontmatter.match(/description:\s*(.+)/);
	if (descMatch) {
		description = descMatch[1];
	}
}

// Get title from first H1 and remove it from content
const titleMatch = markdownContent.match(/^#\s+(.+)$/m);
const title = titleMatch ? titleMatch[1] : 'Proposals';
const contentWithoutTitle = markdownContent.replace(/^#\s+.+$/m, '').trim();

// Render markdown to HTML
const marked = new Marked();
const renderedContent = await marked.parse(contentWithoutTitle);

// Get all proposals
const proposals = await getCollection('proposals');

// Sort by date if available, otherwise by title
const sortedProposals = proposals.sort((a, b) => {
	if (a.data.lastUpdated && b.data.lastUpdated) {
		return b.data.lastUpdated.getTime() - a.data.lastUpdated.getTime();
	}
	const titleA = a.data.title || a.id;
	const titleB = b.data.title || b.id;
	return titleA.localeCompare(titleB);
});
---

<StarlightPage frontmatter={{ title, description }}>
	<div class="sl-markdown-content">
		<div set:html={renderedContent} />

		<hr />

		<h2>Browse All Proposals</h2>
		{sortedProposals.length === 0 ? (
			<p class="empty-state">
				No proposals have been archived yet. This collection will grow as governance decisions are documented.
			</p>
		) : (
			<div class="card-grid">
				{sortedProposals.map(proposal => (
					<a href={`/proposals/${proposal.id}/`} class="card">
						<h4>{proposal.data.title || proposal.id.replace('.md', '')}</h4>
						{proposal.data.description && (
							<p>{proposal.data.description}</p>
						)}
					</a>
				))}
			</div>
		)}
	</div>

	<style>
		hr {
			margin: 3rem 0;
			border: none;
			border-top: 1px solid var(--sl-color-gray-5);
		}

		.empty-state {
			padding: 2rem;
			background: var(--sl-color-gray-6);
			border-radius: 0.5rem;
			text-align: center;
			color: var(--sl-color-gray-2);
		}

		.card-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 1.5rem;
			margin: 1rem 0 2rem;
		}

		.card {
			display: block;
			padding: 1.5rem;
			border: 1px solid var(--sl-color-gray-5);
			border-radius: 0.5rem;
			text-decoration: none;
			color: var(--sl-color-text);
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.card:hover {
			border-color: var(--sl-color-accent);
			box-shadow: 0 0 0 1px var(--sl-color-accent);
		}

		.card h4 {
			margin-top: 0;
			margin-bottom: 0.5rem;
			color: var(--sl-color-white);
		}

		.card p {
			margin: 0;
			font-size: 0.9rem;
			line-height: 1.5;
			color: var(--sl-color-gray-2);
		}
	</style>
</StarlightPage>
