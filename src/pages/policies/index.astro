---
import { getCollection } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { readFile } from 'node:fs/promises';
import { Marked } from 'marked';

// Read and parse the index.md file from the governance submodule
const indexPath = './src/content/governance/policies/index.md';
const indexContent = await readFile(indexPath, 'utf-8');

// Extract frontmatter
const frontmatterMatch = indexContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
let description = 'Practical coordination mechanisms across different operational domains';
let markdownContent = indexContent;

if (frontmatterMatch) {
	const frontmatter = frontmatterMatch[1];
	markdownContent = frontmatterMatch[2];
	const descMatch = frontmatter.match(/description:\s*(.+)/);
	if (descMatch) {
		description = descMatch[1];
	}
}

// Get title from first H1 and remove it from content
const titleMatch = markdownContent.match(/^#\s+(.+)$/m);
const title = titleMatch ? titleMatch[1] : 'Policies';
const contentWithoutTitle = markdownContent.replace(/^#\s+.+$/m, '').trim();

// Render markdown to HTML
const marked = new Marked();
const renderedContent = await marked.parse(contentWithoutTitle);

// Get all policies and group by folder
const policies = await getCollection('policies');

// Group by first folder segment
const groupedPolicies: Record<string, typeof policies> = {};
policies.forEach(policy => {
	const folder = policy.id.split('/')[0] || 'other';
	if (!groupedPolicies[folder]) {
		groupedPolicies[folder] = [];
	}
	groupedPolicies[folder].push(policy);
});

const formatFolderName = (folder: string) => {
	return folder.charAt(0).toUpperCase() + folder.slice(1);
};
---

<StarlightPage frontmatter={{ title, description }}>
	<div class="sl-markdown-content">
		<div set:html={renderedContent} />

		<hr />

		<h2>Browse All Policies</h2>
		{Object.entries(groupedPolicies).sort().map(([folder, items]) => (
			<div class="policy-group">
				<h3>{formatFolderName(folder)}</h3>
				<ul>
					{items.map(policy => (
						<li>
							<a href={`/policies/${policy.id}/`}>
								{policy.data.title || policy.id.split('/').pop()?.replace('.md', '')}
							</a>
						</li>
					))}
				</ul>
			</div>
		))}
	</div>

	<style>
		hr {
			margin: 3rem 0;
			border: none;
			border-top: 1px solid var(--sl-color-gray-5);
		}

		.policy-group {
			margin-bottom: 2rem;
		}

		.policy-group h3 {
			margin-top: 1.5rem;
			margin-bottom: 0.75rem;
		}

		.policy-group ul {
			list-style: none;
			padding-left: 0;
		}

		.policy-group li {
			margin-bottom: 0.5rem;
			padding-left: 1.5rem;
			position: relative;
		}

		.policy-group li::before {
			content: "â†’";
			position: absolute;
			left: 0;
			color: var(--sl-color-accent);
		}

		.policy-group a {
			text-decoration: none;
		}

		.policy-group a:hover {
			text-decoration: underline;
		}
	</style>
</StarlightPage>
