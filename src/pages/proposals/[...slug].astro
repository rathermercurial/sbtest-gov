---
/**
 * Dynamic route for governance proposals
 *
 * Generates pages for all entries in the 'proposals' collection.
 * Uses Starlight components for consistent UI/aesthetics.
 *
 * Routes generated:
 * - /proposals/* (Snapshot proposals from superbenefit.eth)
 *
 * Enhanced to display Snapshot-specific voting metadata including:
 * - Voting results and winning choice
 * - Proposal author and dates
 * - Participation metrics
 */
import { getCollection, render } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

export async function getStaticPaths() {
	const proposals = await getCollection('proposals');
	return proposals.map(entry => ({
		params: { slug: entry.id },
		props: { entry },
	}));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

// Use title from frontmatter or extract from first H1
const title = entry.data.title || headings.find(h => h.depth === 1)?.text || 'Untitled';
const frontmatter = { ...entry.data, title };

// Helper function to format dates
const formatDate = (date: Date | undefined) => {
	if (!date) return 'N/A';
	return new Intl.DateTimeFormat('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric',
	}).format(date);
};

// Helper function to shorten Ethereum addresses
const shortenAddress = (address: string | undefined) => {
	if (!address) return 'Unknown';
	return `${address.slice(0, 6)}...${address.slice(-4)}`;
};
---

<StarlightPage {frontmatter} {headings}>
	{entry.data.snapshotId && (
		<div class="snapshot-metadata" style="background: var(--sl-color-bg-accent); border: 1px solid var(--sl-color-hairline-light); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
			<h2 style="margin-top: 0; font-size: 1.25rem; color: var(--sl-color-white);">Voting Results</h2>

			<div class="metadata-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
				{entry.data.winningChoice && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">Result:</strong>
						<div style="font-size: 1.1rem; color: var(--sl-color-white); font-weight: 600;">
							{entry.data.winningChoice}
						</div>
					</div>
				)}

				{entry.data.percentageVoted !== undefined && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">Winning Vote:</strong>
						<div style="font-size: 1.1rem; color: var(--sl-color-white);">
							{entry.data.percentageVoted.toFixed(2)}%
						</div>
					</div>
				)}

				{entry.data.votes !== undefined && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">Total Voters:</strong>
						<div style="font-size: 1.1rem; color: var(--sl-color-white);">
							{entry.data.votes}
						</div>
					</div>
				)}
			</div>

			{entry.data.choices && entry.data.scores && (
				<details style="margin-top: 1rem;">
					<summary style="cursor: pointer; color: var(--sl-color-gray-2); font-weight: 600;">
						View All Choices & Scores
					</summary>
					<div style="margin-top: 1rem;">
						{entry.data.choices.map((choice: string, index: number) => (
							<div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--sl-color-hairline-light);">
								<span style="color: var(--sl-color-white);">{choice}</span>
								<span style="color: var(--sl-color-gray-2);">
									{entry.data.scores![index]?.toFixed(2) || 0}
									({entry.data.scores_total ? ((entry.data.scores![index] / entry.data.scores_total) * 100).toFixed(2) : 0}%)
								</span>
							</div>
						))}
					</div>
				</details>
			)}

			<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--sl-color-hairline-light); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
				{entry.data.author && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">Author:</strong>
						<div style="color: var(--sl-color-white); font-family: monospace;">
							{shortenAddress(entry.data.author)}
						</div>
					</div>
				)}

				{entry.data.startDate && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">Start Date:</strong>
						<div style="color: var(--sl-color-white);">
							{formatDate(entry.data.startDate)}
						</div>
					</div>
				)}

				{entry.data.endDate && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">End Date:</strong>
						<div style="color: var(--sl-color-white);">
							{formatDate(entry.data.endDate)}
						</div>
					</div>
				)}

				{entry.data.snapshotId && (
					<div>
						<strong style="color: var(--sl-color-gray-2);">Snapshot:</strong>
						<div style="color: var(--sl-color-white);">
							<a
								href={`https://snapshot.org/#/superbenefit.eth/proposal/${entry.data.snapshotId}`}
								target="_blank"
								rel="noopener noreferrer"
								style="color: var(--sl-color-text-accent); text-decoration: underline;"
							>
								View on Snapshot â†—
							</a>
						</div>
					</div>
				)}
			</div>
		</div>
	)}

	<Content />
</StarlightPage>
