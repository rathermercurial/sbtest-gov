---
import { getCollection } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { readFile } from 'node:fs/promises';
import { Marked } from 'marked';

// Read and parse the index.md file from the governance submodule
const indexPath = './src/content/governance/policies/index.md';
const indexContent = await readFile(indexPath, 'utf-8');

// Extract frontmatter
const frontmatterMatch = indexContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
let description = 'Practical coordination mechanisms across different operational domains';
let markdownContent = indexContent;

if (frontmatterMatch) {
	const frontmatter = frontmatterMatch[1];
	markdownContent = frontmatterMatch[2];
	const descMatch = frontmatter.match(/description:\s*(.+)/);
	if (descMatch) {
		description = descMatch[1];
	}
}

// Get title from first H1 and remove it from content
const titleMatch = markdownContent.match(/^#\s+(.+)$/m);
const title = titleMatch ? titleMatch[1] : 'Policies';
const contentWithoutTitle = markdownContent.replace(/^#\s+.+$/m, '').trim();

// Render markdown to HTML
const marked = new Marked();
const renderedContent = await marked.parse(contentWithoutTitle);

// Get all policies and group by folder
const policies = await getCollection('policies');

// Group by first folder segment
const groupedPolicies: Record<string, typeof policies> = {};
policies.forEach(policy => {
	const folder = policy.id.split('/')[0] || 'other';
	if (!groupedPolicies[folder]) {
		groupedPolicies[folder] = [];
	}
	groupedPolicies[folder].push(policy);
});

const formatFolderName = (folder: string) => {
	return folder.charAt(0).toUpperCase() + folder.slice(1);
};
---

<StarlightPage frontmatter={{ title, description }}>
	<div class="sl-markdown-content">
		<div set:html={renderedContent} />

		<hr />

		<h2>Browse All Policies</h2>
		{Object.entries(groupedPolicies).sort().map(([folder, items]) => (
			<div class="policy-group">
				<h3>{formatFolderName(folder)}</h3>
				<div class="card-grid">
					{items.map(policy => (
						<a href={`/policies/${policy.id}/`} class="card">
							<h4>{policy.data.title || policy.id.split('/').pop()?.replace('.md', '')}</h4>
							{policy.data.description && (
								<p>{policy.data.description}</p>
							)}
						</a>
					))}
				</div>
			</div>
		))}
	</div>

	<style>
		hr {
			margin: 3rem 0;
			border: none;
			border-top: 1px solid var(--sl-color-gray-5);
		}

		.policy-group {
			margin-bottom: 3rem;
		}

		.policy-group h3 {
			margin-top: 2rem;
			margin-bottom: 1rem;
		}

		.card-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 1.5rem;
			margin: 1rem 0 2rem;
		}

		.card {
			display: block;
			padding: 1.5rem;
			border: 1px solid var(--sl-color-gray-5);
			border-radius: 0.5rem;
			text-decoration: none;
			color: var(--sl-color-text);
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.card:hover {
			border-color: var(--sl-color-accent);
			box-shadow: 0 0 0 1px var(--sl-color-accent);
		}

		.card h4 {
			margin-top: 0;
			margin-bottom: 0.5rem;
			color: var(--sl-color-white);
		}

		.card p {
			margin: 0;
			font-size: 0.9rem;
			line-height: 1.5;
			color: var(--sl-color-gray-2);
		}
	</style>
</StarlightPage>
